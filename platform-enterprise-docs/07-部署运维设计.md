# Platform Enterprise - 部署运维设计

> 容器化部署与 DevOps 实践方案

## 1. 部署架构

### 1.1 整体部署拓扑

```
                              ┌─────────────────────────────────────────┐
                              │              Internet                    │
                              └─────────────────┬───────────────────────┘
                                                │
                              ┌─────────────────▼───────────────────────┐
                              │          CDN (静态资源)                  │
                              │      CloudFront / Aliyun CDN             │
                              └─────────────────┬───────────────────────┘
                                                │
                              ┌─────────────────▼───────────────────────┐
                              │            WAF + DDoS                    │
                              │         安全防护层                        │
                              └─────────────────┬───────────────────────┘
                                                │
                              ┌─────────────────▼───────────────────────┐
                              │         Load Balancer (L7)               │
                              │          Nginx / ALB                     │
                              └─────────────────┬───────────────────────┘
                                                │
┌───────────────────────────────────────────────┼───────────────────────────────────────────────┐
│                                   Kubernetes Cluster                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Ingress Controller (Nginx)                                  │ │
│  └───────────────────────────────────────┬─────────────────────────────────────────────────┘ │
│                                          │                                                   │
│  ┌───────────────────┬───────────────────┼───────────────────┬─────────────────────────────┐ │
│  │                   │                   │                   │                             │ │
│  │  platform-ui      │  platform-gateway │  platform-auth    │  platform-user             │ │
│  │  (Nginx + SPA)    │  (API Gateway)    │  (Auth Service)   │  (User Service)            │ │
│  │  Replicas: 3      │  Replicas: 3      │  Replicas: 2      │  Replicas: 3               │ │
│  └───────────────────┴───────────────────┴───────────────────┴─────────────────────────────┘ │
│                                                                                              │
│  ┌───────────────────┬───────────────────┬───────────────────┬─────────────────────────────┐ │
│  │                   │                   │                   │                             │ │
│  │  platform-business│  platform-file    │  platform-message │  platform-job              │ │
│  │  (Business Svc)   │  (File Service)   │  (Message Service)│  (Job Service)             │ │
│  │  Replicas: 5      │  Replicas: 2      │  Replicas: 2      │  Replicas: 1               │ │
│  └───────────────────┴───────────────────┴───────────────────┴─────────────────────────────┘ │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
                                                │
┌───────────────────────────────────────────────┼───────────────────────────────────────────────┐
│                                    Data Layer                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │   PostgreSQL    │  │     Redis       │  │  Elasticsearch  │  │    RabbitMQ     │         │
│  │   (HA Cluster)  │  │   (Cluster)     │  │   (Cluster)     │  │   (Cluster)     │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 环境规划

| 环境 | 用途 | 集群规模 | 数据库 |
|------|------|---------|--------|
| dev | 开发调试 | 单节点 | 共享实例 |
| test | 功能测试 | 3 节点 | 独立实例 |
| staging | 预发布 | 3 节点 | 生产副本 |
| prod | 生产环境 | 6+ 节点 | HA 集群 |

## 2. 容器化

### 2.1 Dockerfile (后端服务)

```dockerfile
# platform-user/Dockerfile

# 构建阶段
FROM eclipse-temurin:21-jdk-alpine AS builder

WORKDIR /app

# 复制 Maven 配置
COPY pom.xml .
COPY .mvn .mvn
COPY mvnw .

# 下载依赖 (利用 Docker 缓存)
RUN ./mvnw dependency:go-offline -B

# 复制源码
COPY src src

# 构建
RUN ./mvnw package -DskipTests -B

# 提取分层
RUN java -Djarmode=layertools -jar target/*.jar extract

# 运行阶段
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

# 安全设置：非 root 用户
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

# 复制分层
COPY --from=builder /app/dependencies/ ./
COPY --from=builder /app/spring-boot-loader/ ./
COPY --from=builder /app/snapshot-dependencies/ ./
COPY --from=builder /app/application/ ./

# 切换用户
USER appuser

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD wget -q --spider http://localhost:8082/actuator/health || exit 1

# JVM 配置
ENV JAVA_OPTS="-XX:+UseZGC \
    -XX:MaxRAMPercentage=75 \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/tmp \
    -Djava.security.egd=file:/dev/./urandom"

EXPOSE 8082

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS org.springframework.boot.loader.launch.JarLauncher"]
```

### 2.2 Dockerfile (前端)

```dockerfile
# platform-ui/Dockerfile

# 构建阶段
FROM node:22-alpine AS builder

WORKDIR /app

# 复制 package 文件
COPY package.json pnpm-lock.yaml ./

# 安装 pnpm 并下载依赖
RUN corepack enable && pnpm install --frozen-lockfile

# 复制源码
COPY . .

# 构建
ARG VITE_API_BASE_URL
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}

RUN pnpm build

# 运行阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
    CMD wget -q --spider http://localhost/health || exit 1

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 2.3 Nginx 配置

```nginx
# platform-ui/nginx.conf
server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "OK";
    }

    # 静态资源缓存
    location /assets {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API 代理
    location /api {
        proxy_pass http://platform-gateway:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

## 3. Kubernetes 部署

### 3.1 Namespace 和资源配额

```yaml
# k8s/base/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: platform
  labels:
    name: platform
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: platform-quota
  namespace: platform
spec:
  hard:
    requests.cpu: "20"
    requests.memory: "40Gi"
    limits.cpu: "40"
    limits.memory: "80Gi"
    pods: "100"
```

### 3.2 ConfigMap

```yaml
# k8s/base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: platform-config
  namespace: platform
data:
  SPRING_PROFILES_ACTIVE: "prod"
  SERVER_TOMCAT_THREADS_MAX: "200"
  SPRING_THREADS_VIRTUAL_ENABLED: "true"
  MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "health,info,prometheus"
  LOGGING_LEVEL_ROOT: "INFO"
```

### 3.3 Secret

```yaml
# k8s/base/secret.yaml (示例，生产使用 Sealed Secrets 或 Vault)
apiVersion: v1
kind: Secret
metadata:
  name: platform-secret
  namespace: platform
type: Opaque
data:
  DB_PASSWORD: cGFzc3dvcmQ=  # base64 encoded
  REDIS_PASSWORD: cGFzc3dvcmQ=
  JWT_SECRET: c2VjcmV0a2V5MTIzNDU2
```

### 3.4 Deployment

```yaml
# k8s/services/platform-user/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform-user
  namespace: platform
  labels:
    app: platform-user
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: platform-user
  template:
    metadata:
      labels:
        app: platform-user
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8082"
        prometheus.io/path: "/actuator/prometheus"
    spec:
      serviceAccountName: platform-user
      terminationGracePeriodSeconds: 60

      # 亲和性配置
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: platform-user
                topologyKey: kubernetes.io/hostname

      containers:
        - name: platform-user
          image: registry.company.com/platform/platform-user:1.0.0
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8082

          envFrom:
            - configMapRef:
                name: platform-config
            - secretRef:
                name: platform-secret

          env:
            - name: SPRING_APPLICATION_NAME
              value: "platform-user"
            - name: SERVER_PORT
              value: "8082"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "2Gi"

          # 就绪探针
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8082
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          # 存活探针
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8082
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          # 启动探针
          startupProbe:
            httpGet:
              path: /actuator/health
              port: 8082
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30

          # 生命周期钩子
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 10"]

      imagePullSecrets:
        - name: registry-secret
```

### 3.5 Service

```yaml
# k8s/services/platform-user/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: platform-user
  namespace: platform
  labels:
    app: platform-user
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8082
      targetPort: 8082
  selector:
    app: platform-user
```

### 3.6 Ingress

```yaml
# k8s/ingress/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: platform-ingress
  namespace: platform
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
    - hosts:
        - platform.company.com
        - api.platform.company.com
      secretName: platform-tls
  rules:
    # 前端
    - host: platform.company.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: platform-ui
                port:
                  number: 80

    # API
    - host: api.platform.company.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: platform-gateway
                port:
                  number: 8080
```

### 3.7 HPA (自动伸缩)

```yaml
# k8s/services/platform-user/hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: platform-user-hpa
  namespace: platform
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: platform-user
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
```

## 4. CI/CD 流水线

### 4.1 GitHub Actions

```yaml
# .github/workflows/ci-cd.yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # 代码检查
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Run Checkstyle
        run: ./mvnw checkstyle:check

  # 单元测试
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Run Tests
        run: ./mvnw test

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: target/site/jacoco/jacoco.xml

  # 构建镜像
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: [platform-gateway, platform-auth, platform-user, platform-business]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 部署到 Staging
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Deploy to Staging
        run: |
          kubectl set image deployment/platform-user \
            platform-user=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/platform-user:${{ github.sha }} \
            -n platform

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/platform-user -n platform --timeout=300s

  # 部署到生产
  deploy-prod:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          # 使用 Argo CD 或类似工具进行生产部署
          echo "Deploying to production..."
```

### 4.2 ArgoCD Application

```yaml
# argocd/platform-user.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: platform-user
  namespace: argocd
spec:
  project: platform

  source:
    repoURL: https://github.com/company/platform-k8s.git
    targetRevision: HEAD
    path: services/platform-user

    helm:
      valueFiles:
        - values-prod.yaml

  destination:
    server: https://kubernetes.default.svc
    namespace: platform

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

## 5. 监控与告警

### 5.1 Prometheus 配置

```yaml
# prometheus/service-monitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: platform-services
  namespace: monitoring
spec:
  selector:
    matchLabels:
      monitor: platform
  namespaceSelector:
    matchNames:
      - platform
  endpoints:
    - port: http
      path: /actuator/prometheus
      interval: 15s
```

### 5.2 Grafana Dashboard

```json
{
  "title": "Platform Services Overview",
  "panels": [
    {
      "title": "Request Rate",
      "type": "graph",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_count{namespace=\"platform\"}[5m])) by (service)"
        }
      ]
    },
    {
      "title": "Response Time (P99)",
      "type": "graph",
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{namespace=\"platform\"}[5m])) by (le, service))"
        }
      ]
    },
    {
      "title": "Error Rate",
      "type": "graph",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_count{namespace=\"platform\", status=~\"5..\"}[5m])) by (service)"
        }
      ]
    }
  ]
}
```

### 5.3 告警规则

```yaml
# prometheus/alerts.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: platform-alerts
  namespace: monitoring
spec:
  groups:
    - name: platform.rules
      rules:
        # 高错误率告警
        - alert: HighErrorRate
          expr: |
            sum(rate(http_server_requests_seconds_count{namespace="platform", status=~"5.."}[5m])) /
            sum(rate(http_server_requests_seconds_count{namespace="platform"}[5m])) > 0.05
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "服务错误率过高"
            description: "{{ $labels.service }} 错误率超过 5%"

        # 响应时间告警
        - alert: HighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_server_requests_seconds_bucket{namespace="platform"}[5m])) by (le, service)
            ) > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "服务响应时间过长"
            description: "{{ $labels.service }} P99 响应时间超过 2 秒"

        # Pod 重启告警
        - alert: PodRestartingTooMuch
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="platform"}[1h]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod 频繁重启"
            description: "{{ $labels.pod }} 在过去 1 小时内重启超过 3 次"
```

## 6. 日志管理

### 6.1 EFK Stack 配置

```yaml
# fluentd/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: logging
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/platform-*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      <parse>
        @type json
        time_key time
        time_format %Y-%m-%dT%H:%M:%S.%NZ
      </parse>
    </source>

    <filter kubernetes.**>
      @type kubernetes_metadata
    </filter>

    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      logstash_format true
      logstash_prefix platform
      include_tag_key true
    </match>
```

### 6.2 日志格式规范

```yaml
# application.yml
logging:
  pattern:
    console: '{"timestamp":"%d{yyyy-MM-dd HH:mm:ss.SSS}","level":"%level","service":"${spring.application.name}","traceId":"%X{traceId}","spanId":"%X{spanId}","class":"%logger{36}","message":"%msg"}%n'
  level:
    root: INFO
    com.company.platform: DEBUG
```

---

**文档版本**: 1.0.0
**最后更新**: 2026-01-06
